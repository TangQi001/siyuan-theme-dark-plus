import { config } from './js/config.js';
import { Iterator } from './js/utils.js';
import {
    queryBlock,
    queryAsset,
    getNotebookConf,
    exportMdContent,
    updateBlock,
    getFile,
    putFile,
} from './js/api.js';

async function init(params) {
    document.body.style.fontFamily = config.UI.fontFamily.join(',');

    let r; // ÂìçÂ∫î
    let b; // Âùó
    let n; // Á¨îËÆ∞Êú¨
    let t; // ‰∏¥Êó∂
    switch (params.mode) {
        case 'assets':
            // TODO ÂÆåÊï¥ URL ËµÑÊ∫ê
            if (params.url) return;

            switch (true) {
                case params.path.startsWith('assets/'):
                    r = await queryAsset(params.path);
                    if (!(r
                        && r.code === 0
                        && r.data.length > 0
                    )) params.path = `/data/${params.path}`; // Ê≤°ÊúâÊü•ËØ¢Âà∞ËµÑÊ∫êÊñá‰ª∂
                    else {
                        for (const asset of r.data) {
                            b = asset;
                            let paths = `${b.box}${b.docpath}`.split('/');
                            for (let i = 0; i < paths.length; ++i) {
                                t = `/data/${paths.slice(0, i).join('/')}/${b.path}`.replaceAll('//', '/');
                                r = await getFile(t);
                                if (r) break;
                            }
                            if (r) {
                                params.block = b;
                                params.path = t;
                                params.value = await r.text();
                                break;
                            }
                        }
                    }
                    break;
                case params.path.startsWith('/assets/'):
                    params.path = `/data${params.path}`;
                    break;
                case params.path.startsWith('widgets/'):
                    params.path = `/data/${params.path}`;
                    break;
                case params.path.startsWith('/widgets/'):
                    params.path = `/data${params.path}`;
                    break;
                case params.path.startsWith('emojies/'):
                    params.path = `/data/${params.path}`;
                    break;
                case params.path.startsWith('/emojies/'):
                    params.path = `/data${params.path}`;
                    break;
                case params.path.startsWith('appearance/'):
                    params.path = `/conf/${params.path}`;
                    break;
                case params.path.startsWith('/appearance/'):
                    params.path = `/conf${params.path}`;
                    break;
                case params.path.startsWith('export/'):
                    params.path = `/temp/${params.path}`;
                    break;
                case params.path.startsWith('/export/'):
                    params.path = `/temp${params.path}`;
                    break;
            }
            params.path.replaceAll('\\', '/').replaceAll('//', '/');
            r = await getFile(params.path);
            if (r) {
                params.mode = 'assets';
                params.value = await r.text();
                params.language = params.path.substring(params.path.lastIndexOf('.') + 1);
            }
            else return;
            break;
        case 'block':
            if (!config.regs.id.test(window.editor.params.id)) return;

            // Ëé∑ÂèñÂùó
            r = await queryBlock(params.id);
            // console.log(r);
            if (!(r
                && r.code === 0
                && r.data.length === 1
            )) return; // Ê≤°ÊúâÊü•ËØ¢Âà∞Âùó
            b = r.data[0];

            // Ëé∑ÂèñÁ¨îËÆ∞Êú¨
            r = await getNotebookConf(b.box);
            if (!(r
                && r.code === 0
            )) return; // Ê≤°ÊúâÊü•ËØ¢Âà∞Á¨îËÆ∞Êú¨
            n = r.data;
            switch (b.type) {
                case 'html':
                case 'video':
                case 'audio':
                case 'widget':
                case 'iframe':
                    params.mode = 'html';
                    params.value = b.markdown;
                    params.language = 'html';
                    break;
                case 'query_embed': // ÂµåÂÖ•Âùó
                    t = config.regs.query.exec(b.markdown);
                    if (t && t.length === 2) {
                        params.mode = 'query';
                        params.value = t[1];
                        params.language = 'sql';
                    }
                    break;
                case 'd': // ÊñáÊ°£Âùó
                    r = await exportMdContent(b.id);
                    if (!(r && r.code === 0)) return;
                    else {
                        params.mode = 'doc';
                        params.value = r.data.content;
                        params.language = 'markdown';
                        params.tabSize = 2;
                    }
                    break;
                case 'c': // ‰ª£Á†ÅÂùó
                    t = config.regs.code.exec(b.markdown);
                    if (t && t.length === 2) {
                        params.mode = 'code';
                        params.value = b.content;
                        params.language = t[1];
                    }
                    break;
                default:
                    params.mode = 'block';
                    params.value = b.markdown;
                    params.language = 'markdown';
                    params.tabSize = 2;
                    break;
            }
            // params.value = `${b.markdown}\n${b.ial}`;
            // console.log(params);
            params.block = b;
            params.breadcrumb.set(
                `‚í∑${config.MAP.LABELS.type[b.type][params.lang] || config.MAP.LABELS.type[b.type].default}`,
                `üÑΩ${n.name}${b.hpath.replaceAll('/', ' > ')}`,
                `siyuan://blocks/${b.id}`,
                `${n.name}${b.hpath}`,
                `siyuan://blocks/${b.id}`,
                `siyuan://blocks/${b.root_id}`,
            );
            break;
        case 'none':
        default:
            break;
    }
}

window.onload = () => {
    try {
        window.editor = {};
        window.editor.url = new URL(window.location.href);
        window.editor.picker = document.getElementById('picker');
        window.editor.params = {
            breadcrumb: {
                type: document.getElementById('type'),
                crumb: document.getElementById('crumb'),
                set: (typeText, hpathText, typeTitle, hpathTitle, blockHref, docHref) => {
                    window.editor.params.breadcrumb.type.href = blockHref;
                    window.editor.params.breadcrumb.type.innerText = typeText;
                    window.editor.params.breadcrumb.type.setAttribute('title', typeTitle);
                    window.editor.params.breadcrumb.crumb.href = docHref;
                    window.editor.params.breadcrumb.crumb.innerText = hpathText;
                    window.editor.params.breadcrumb.crumb.setAttribute('title', hpathTitle);
                },
            },
            picker: {
                element: document.getElementById('picker'),
                set: (value) => {
                    window.editor.params.picker.element.value = value;
                },
            },
            id: window.editor.url.searchParams.get('id')
                || null, // Âùó ID
            url: decodeURI(window.editor.url.searchParams.get('url') || '')
                || null, // ËµÑÊ∫êÂÆåÊï¥ URL
            path: decodeURI(window.editor.url.searchParams.get('path') || '')
                || null, // ËµÑÊ∫êË∑ØÂæÑ
            /**
             * Ê®°Âºè
             * 'none': ÁôΩÊùø
             * 'assets': ËµÑÊ∫ê
             *     -> 'assets': ËµÑÊ∫ê
             *     -> 'file': Êñá‰ª∂
             * 'block': Âùó
             *     -> 'block': ÊôÆÈÄöÂùó
             *     -> 'query': ÂµåÂÖ•Âùó
             *     -> 'code': ‰ª£Á†ÅÂùó
             *     -> 'html': htmlÂùó
             *     -> 'doc': ÊñáÊ°£Âùó
             */
            mode: window.editor.url.searchParams.get('mode')
                || 'none',
            value: '',
            theme: window.editor.url.searchParams.get('theme')
                || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 1 : 0),
            lang: window.editor.url.searchParams.get('lang')
                || 'default',
            language: window.editor.url.searchParams.get('language')
                || 'default',
            tabSize: parseInt(window.editor.url.searchParams.get('tabSize'))
                || 4,
            // REF [JS UnicodeÁºñÁ†ÅÂíåËß£Á†ÅÔºà6ÁßçÊñπÊ≥ïÔºâ](http://c.biancheng.net/view/5602.html)
            body: JSON.parse(decodeURI(window.editor.url.hash.substr(1)) || null),
        };
        init(window.editor.params).then(() => {
            window.editor.container = document.getElementById('container');
            window.editor.picker = document.getElementById('picker');

            require.config({
                paths: {
                    vs: '/appearance/themes/Dark+/app/editor/vs'
                    // vs: '/appearance/themes/Dark+/script/test/monaco/0.33.0/dev/vs'
                },
            });
            require.config({
                'vs/nls': {
                    availableLanguages: {
                        '*': config.MAP.LANGS[window.editor.params.lang]
                            || config.MAP.LANGS.default
                            || '',
                    },
                },
            });
            require(['vs/editor/editor.main'], () => {
                let language = config.MAP.LANGUAGES[window.editor.params.language.toLowerCase()]
                    || window.editor.params.language
                    || 'plaintext';
                window.editor.picker.value = language;
                window.editor.editor = monaco.editor.create(
                    container,
                    Object.assign(
                        Object.assign(
                            config.IStandaloneEditorConstructionOptions, // ÈªòËÆ§ÈÖçÁΩÆ
                            {
                                language: language, // ËØ≠Ë®ÄÊ®°Âºè
                                theme: config.MAP.THEMES[window.editor.params.theme]
                                    || config.MAP.THEMES.default
                                    || 'vs', // ‰∏ªÈ¢ò
                                value: window.editor.params.tabSize || 4, // ÂàùÂßãÂÄº
                                value: window.editor.params.value, // ÂàùÂßãÂÄº
                            }, // URL params ÈÖçÁΩÆ
                        ),
                        window.editor.params.body
                            ? window.editor.params.body.IStandaloneEditorConstructionOptions
                            : null, // URL hash ÈÖçÁΩÆ
                    ),
                );

                /* ËÆæÁΩÆËØ≠Ë®ÄÊ†áÁ≠æ */
                window.editor.picker.onchange = () => {
                    // console.log(window.editor.picker.value);
                    // window.editor.params.lang = window.editor.picker.value;
                    monaco.editor.setModelLanguage(window.editor.editor.getModel(), window.editor.picker.value);
                };

                /* üëáüëá Âè≥ÈîÆËèúÂçïÈ°π üëáüëá */
                // REF [IActionDescriptor | Monaco Editor API](https://microsoft.github.io/monaco-editor/api/interfaces/monaco.editor.IActionDescriptor.html)
                window.editor.editor.addAction({ // ‰øùÂ≠ò
                    id: '18730D32-5451-4102-B299-BE281BA929B9', // ËèúÂçïÈ°π id
                    label: config.MAP.LABELS.save[window.editor.params.lang]
                        || config.MAP.LABELS.save.default, // ËèúÂçïÈ°πÂêçÁß∞
                    // REF [KeyMod | Monaco Editor API](https://microsoft.github.io/monaco-editor/api/classes/monaco.KeyMod.html)
                    // REF [KeyCode | Monaco Editor API](https://microsoft.github.io/monaco-editor/api/enums/monaco.KeyCode.html)
                    keybindings: [monaco.KeyMod.CtrlCmd | monaco.KeyCode.KeyS], // ÁªëÂÆöÂø´Êç∑ÈîÆ
                    // keybindingContext: 'Ctrl+S', // ÁªëÂÆöÂø´Êç∑ÈîÆ‰∏ä‰∏ãÊñá
                    contextMenuGroupId: '9_file', // ÊâÄÂ±ûËèúÂçïÁöÑÂàÜÁªÑ
                    run: () => {
                        switch (window.editor.params.mode) {
                            case 'file':
                                break;
                            case 'assets':
                                putFile(
                                    window.editor.params.path,
                                    window.editor.editor.getValue(),
                                );
                                break;
                            case 'query':
                                updateBlock(
                                    window.editor.params.id,
                                    `\{\{${window.editor.editor.getValue().trim()}\}\}\n${window.editor.params.block.ial}`,
                                );
                                break;
                            case 'code':
                                updateBlock(
                                    window.editor.params.id,
                                    `\`\`\`${window.editor.params.language}\n${window.editor.editor.getValue()}\n\`\`\`\n${window.editor.params.block.ial}`,
                                );
                                break;
                            case 'doc':
                                updateBlock(
                                    window.editor.params.id,
                                    window.editor.editor.getValue(),
                                );
                                break;
                            case 'html':
                            case 'block':
                                updateBlock(
                                    window.editor.params.id,
                                    `${window.editor.editor.getValue().trim()}\n${window.editor.params.block.ial}`,
                                );
                                break;
                            case 'none':
                            default:
                                break;
                        }
                    }, // ÁÇπÂáªÂêéÊâßË°åÁöÑÊìç‰Ωú
                });

                let wrap_iter = Iterator(['on', 'off'], true);
                window.editor.editor.addAction({ // ÂàáÊç¢ÊäòË°åÁä∂ÊÄÅ
                    id: 'F9E62A24-619E-49EA-A870-B31E6F9D284F', // ËèúÂçïÈ°π id
                    label: config.MAP.LABELS.wrap[window.editor.params.lang]
                        || config.MAP.LABELS.wrap.default, // ËèúÂçïÈ°πÂêçÁß∞
                    keybindings: [monaco.KeyMod.Alt | monaco.KeyCode.KeyZ], // ÁªëÂÆöÂø´Êç∑ÈîÆ
                    // keybindingContext: 'Alt+Z', // ÁªëÂÆöÂø´Êç∑ÈîÆ‰∏ä‰∏ãÊñá
                    contextMenuGroupId: '2_view', // ÊâÄÂ±ûËèúÂçïÁöÑÂàÜÁªÑ
                    run: () => {
                        window.editor.editor.updateOptions({ wordWrap: wrap_iter.next().value });
                    }, // ÁÇπÂáªÂêéÊâßË°åÁöÑÊìç‰Ωú
                });
            });
        });
    } catch (error) {
        console.error(error);
    }
}
